<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Dashboard | UMS</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .modal-bg {
      background-color: rgba(0, 0, 0, 0.5);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Navbar -->
  <nav class="bg-indigo-600 text-white flex items-center justify-between px-6 py-3 shadow">
    <h1 class="text-lg font-semibold flex items-center gap-2">
      <i data-lucide="users" class="w-5 h-5"></i> UMS Admin Dashboard
    </h1>
    <button onclick="logout()" class="flex items-center gap-1 bg-indigo-500 hover:bg-indigo-700 px-3 py-1 rounded-md text-sm">
      <i data-lucide="log-out" class="w-4 h-4"></i> Logout
    </button>
  </nav>

  <!-- Dashboard -->
  <main class="p-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-5">
      <div class="flex items-center gap-3 mb-3 md:mb-0">
        <input id="search" type="text" placeholder="Search user..." class="border border-gray-300 rounded-md px-3 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <select id="roleFilter" class="border border-gray-300 rounded-md px-2 py-2">
          <option value="">All Roles</option>
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <button onclick="openModal()" class="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">
        <i data-lucide="user-plus" class="w-5 h-5"></i> Add User
      </button>
    </div>

    <!-- Users Table -->
    <div class="overflow-x-auto bg-white rounded-lg shadow">
      <table class="min-w-full text-sm">
        <thead class="bg-indigo-50 text-gray-700">
          <tr>
            <th class="py-3 px-4 text-left">Profile</th>
            <th class="py-3 px-4 text-left">Name</th>
            <th class="py-3 px-4 text-left">Email</th>
            <th class="py-3 px-4 text-left">Role</th>
            <th class="py-3 px-4 text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="usersTbody"></tbody>
      </table>
    </div>
  </main>

  <!-- Add/Edit Modal -->
  <div id="userModal" class="hidden fixed inset-0 modal-bg flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-96 shadow-lg">
      <h3 id="modalTitle" class="text-lg font-semibold mb-4">Add User</h3>
      <form id="userForm" class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1">Name</label>
          <input id="modalName" type="text" required class="border rounded-md w-full px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Email</label>
          <input id="modalEmail" type="email" required class="border rounded-md w-full px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Password</label>
          <input id="modalPassword" type="password" class="border rounded-md w-full px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Role</label>
          <select id="modalRole" class="border rounded-md w-full px-3 py-2">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Profile Picture</label>
          <input id="modalPic" type="file" accept="image/*" class="border rounded-md w-full px-3 py-2">
        </div>
        <div class="flex justify-end gap-3 mt-4">
          <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 rounded-md">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    lucide.createIcons();

    const api = 'http://localhost:5000/api';
    const token = localStorage.getItem('token');
    const tbody = document.getElementById('usersTbody');

    let editId = null;

    async function loadUsers(){
      const res = await fetch(api + '/users', {
        headers: { Authorization: 'Bearer ' + token }
      });
      const data = await res.json();
      tbody.innerHTML = '';
      data.users?.forEach(u => {
        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gray-50';
        const pic = u.pic ? `<img src="${u.pic}" class="w-10 h-10 rounded-full object-cover">`
                          : `<div class='w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center text-indigo-700 font-semibold'>${u.name[0]}</div>`;
        tr.innerHTML = `
          <td class="px-4 py-3">${pic}</td>
          <td class="px-4 py-3">${u.name}</td>
          <td class="px-4 py-3">${u.email}</td>
          <td class="px-4 py-3 capitalize">${u.role}</td>
          <td class="px-4 py-3 text-center flex justify-center gap-2">
            <button onclick='editUser("${u._id}", "${u.name}", "${u.email}", "${u.role}")' class='text-indigo-600 hover:text-indigo-800'><i data-lucide="edit"></i></button>
            <button onclick='deleteUser("${u._id}")' class='text-red-600 hover:text-red-800'><i data-lucide="trash-2"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      lucide.createIcons();
    }

    async function deleteUser(id){
      if(confirm('Delete user?')){
        await fetch(api + '/users/' + id, { method:'DELETE', headers:{ Authorization:'Bearer ' + token }});
        loadUsers();
      }
    }

    function openModal(){
      editId = null;
      document.getElementById('modalTitle').textContent = 'Add User';
      document.getElementById('userForm').reset();
      document.getElementById('userModal').classList.remove('hidden');
    }

    function editUser(id, name, email, role){
      editId = id;
      document.getElementById('modalTitle').textContent = 'Edit User';
      modalName.value = name;
      modalEmail.value = email;
      modalRole.value = role;
      document.getElementById('userModal').classList.remove('hidden');
    }

    function closeModal(){
      document.getElementById('userModal').classList.add('hidden');
    }

    document.getElementById('userForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const formData = new FormData();
      formData.append('name', modalName.value);
      formData.append('email', modalEmail.value);
      formData.append('role', modalRole.value);
      if(modalPassword.value) formData.append('password', modalPassword.value);
      if(modalPic.files[0]) formData.append('pic', modalPic.files[0]);
      const method = editId ? 'PUT' : 'POST';
      const url = editId ? `${api}/users/${editId}` : `${api}/users`;
      await fetch(url, {
        method,
        headers: { Authorization: 'Bearer ' + token },
        body: formData
      });
      closeModal();
      loadUsers();
    });

    function logout(){
      localStorage.clear();
      window.location.href = 'login.html';
    }

    loadUsers();
  </script>
</body>
</html>
